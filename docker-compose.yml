# ============================================
# Docker Compose設定ファイル
# ============================================
# 注意: コンテナ名、ボリューム名、ネットワーク名は固定値です
# 複数のプロジェクトで同じコンテナ名を使用する場合は競合する可能性があります
# 別のプロジェクトで使用する場合は、コンテナ名を変更してください
# ============================================

services:
  # MySQLデータベースコンテナ
  db:
    image: mysql:8.0
    container_name: ${THEME_NAME:-nyardpress}_db
    restart: always
    environment:
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wordpress
      MYSQL_PASSWORD: wordpress
      MYSQL_ROOT_PASSWORD: rootpassword
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - "${DB_PORT:-3306}:3306"
    networks:
      - app-network

  # WordPressコンテナ
  wordpress:
    build:
      context: .
      dockerfile: ./docker/Dockerfile
    # コンテナ名: 固定値（安定性重視）
    container_name: ${THEME_NAME:-nyardpress}_wordpress
    restart: always
    env_file:
      - .env
    ports:
      # ポート: .envファイルのWORDPRESS_PORTで変更可能（デフォルト: 8080）
      - "${WP_PORT:-8080}:80"
    environment:
      WORDPRESS_DB_HOST: db
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: wordpress
      WORDPRESS_DB_NAME: wordpress
      THEME_NAME: ${THEME_NAME:-nyardpress}
      MYSQL_ROOT_PASSWORD: rootpassword
      WP_DEBUG: ${WP_DEBUG:-true}
      WP_DEBUG_DISPLAY: ${WP_DEBUG_DISPLAY:-true}
      WP_DEBUG_LOG: ${WP_DEBUG_LOG:-true}
      WP_DEBUG_LOG_FILE: ${WP_DEBUG_LOG_FILE:-/var/www/html/docker/log/debug.log}
      WP_ROOT: ${WP_ROOT:-/var/www/html}
    # サブディレクトリにwordpressをインストールする場合は設定を変える
    working_dir: ${WP_ROOT:-/var/www/html}
    volumes:
      # テーマディレクトリをマウント（ホスト側で編集可能）
      - ./www/htdocs/wp-content/themes:${WP_ROOT:-/var/www/html}/wp-content/themes
      # プラグインディレクトリをマウント（永続化、composer.jsonでプラグイン管理）
      - ./www/htdocs/wp-content/plugins:${WP_ROOT:-/var/www/html}/wp-content/plugins
      # MUプラグインディレクトリをマウント
      - ./www/htdocs/wp-content/mu-plugins:${WP_ROOT:-/var/www/html}/wp-content/mu-plugins
      # 言語パックディレクトリをマウント（永続化）
      - ./www/htdocs/wp-content/languages:${WP_ROOT:-/var/www/html}/wp-content/languages
      # アップロードファイルをマウント（永続化）
      - ./www/htdocs/wp-content/uploads:${WP_ROOT:-/var/www/html}/wp-content/uploads
      # その他ファイル群
      # @TODO ルートにファイルを置くと逆に通常のwp core installできなくなるので一旦コメントアウト
      #- ./www/htdocs/.htaccess:/var/www/html/.htaccess
      # スクリプトディレクトリをマウント（開発環境用：ホスト側での編集が即座に反映）
      - ./docker/bin:/opt/docker/bin
      # ログディレクトリをマウント
      - ./docker/log:/var/www/html/docker/log
      # ダンプディレクトリをマウント（エクスポート/インポート用）
      - ./docker/dump:/var/www/html/docker/dump
      # 注意: 全体をマウント（nyardpress_wordpress_data:/var/www/html/）すると、
      # 上記の個別マウントと競合し、ホスト側での編集が反映されなくなります。
      # 開発環境では個別マウントを推奨します。
      # 必要に応じて個別に追加してください
      # - ./www/htdocs/custom-folder:/var/www/html/custom-folder
    depends_on:
      - db
      - mailpit
    networks:
      - app-network

  # Mailpit（開発環境用メールサーバー）コンテナ
  mailpit:
    image: axllent/mailpit:latest
    container_name: ${THEME_NAME:-nyardpress}_mailpit
    restart: always
    ports:
      - "${SMTP_PORT:-1025}:1025"  # SMTPポート
      - "${MAILPIT_PORT:-8025}:8025"  # Web UIポート
    networks:
      - app-network
    environment:
      MP_SMTP_BIND_ADDR: 0.0.0.0:1025
      MP_WEB_BIND_ADDR: 0.0.0.0:8025

# ============================================
# ボリューム定義
# ============================================
# データベースのデータを永続化するためのボリューム
# ボリューム名: nyardpress_db_data（固定値）
# ============================================
volumes:
  db_data:
    name: ${THEME_NAME:-nyardpress}_db_data

# ============================================
# ネットワーク定義
# ============================================
# コンテナ間通信のためのネットワーク
# ネットワーク名: nyardpress-network（固定値）
# ============================================
networks:
  app-network:
    name: ${THEME_NAME:-nyardpress}-network
    driver: bridge

